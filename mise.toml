#:schema https://mise.jdx.dev/schema/mise.json
min_version = "2025.1.0"

# ============================================================================
# Environment
# ============================================================================

[env]
PROJECT_NAME = "apollos-ai"
PYTHONUNBUFFERED = "1"
PYTHONDONTWRITEBYTECODE = "1"

# Auto-activate .venv when entering directory
_.python.venv = { path = ".venv", create = true }

# ============================================================================
# Tools â€” managed by mise, installed automatically
# ============================================================================

[tools]
python = "3.12"
uv = "latest"
ruff = "latest"
biome = "latest"
git-cliff = "latest"
pkl = "latest"
hk = "latest"

# ============================================================================
# Settings
# ============================================================================

[settings]
experimental = true
jobs = 4
task_output = "prefix"

# ============================================================================
# Setup & Installation
# ============================================================================

[tasks.setup]
description = "First-time project setup (install deps, playwright, git hooks)"
run = '''
uv venv --prompt apollos-ai --allow-existing .venv
uv sync --group dev
uv run playwright install chromium
hk install --mise
echo "Setup complete."
'''

[tasks.install]
description = "Install Python dependencies with uv"
run = "uv sync --group dev"

[tasks."install:prod"]
description = "Install production dependencies only"
run = "uv sync --no-dev"

# ============================================================================
# Running
# ============================================================================

[tasks.run]
alias = "r"
description = "Start the Apollos AI UI server"
run = "uv run python run_ui.py"

# ============================================================================
# Code Quality â€” Ruff (Python) + Biome (CSS)
# ============================================================================

[tasks.lint]
description = "Lint all code (Python + CSS)"
depends = ["lint:python", "lint:css"]

[tasks."lint:python"]
description = "Lint Python code with Ruff"
run = "uv run ruff check python/ tests/ prompts/"

[tasks."lint:python:fix"]
description = "Lint Python code with Ruff (auto-fix)"
run = "uv run ruff check --fix python/ tests/ prompts/"

[tasks."lint:css"]
description = "Lint CSS files with Biome"
run = "biome lint webui/css/"

[tasks.format]
description = "Format all code"
depends = ["format:python"]

[tasks."format:python"]
description = "Format Python code with Ruff"
run = "uv run ruff format python/ tests/ prompts/"

[tasks."format:check"]
description = "Check formatting (CI-friendly, no writes)"
run = "uv run ruff format --check python/ tests/ prompts/"

# ============================================================================
# Testing
# ============================================================================

[tasks.test]
alias = "t"
description = "Run tests with pytest"
run = "uv run pytest tests/ -v"

[tasks."test:coverage"]
description = "Run tests with coverage report"
run = "uv run pytest tests/ -v --cov=python/ --cov-report=term-missing"

# ============================================================================
# Dependencies
# ============================================================================

[tasks."deps:add"]
description = "Add a dependency (usage: mise run deps:add <package>)"
usage = 'arg "<package>" help="Package to add"'
run = '''
uv add "${usage_package}"
uv export --no-hashes --no-dev --no-emit-project -o requirements.txt
echo "Added ${usage_package} â€” requirements.txt regenerated"
'''

[tasks."deps:add-dev"]
description = "Add a dev dependency"
usage = 'arg "<package>" help="Package to add"'
run = '''
uv add --group dev "${usage_package}"
echo "Added ${usage_package} to dev group"
'''

[tasks."deps:export"]
description = "Regenerate requirements.txt from pyproject.toml (for Docker)"
run = '''
uv export --no-hashes --no-dev --no-emit-project -o requirements.txt
echo "requirements.txt regenerated from pyproject.toml"
'''

[tasks."deps:lock"]
description = "Update uv.lock"
run = "uv lock"

# ============================================================================
# Docker
# ============================================================================

# --- Build tasks ---

[tasks."docker:build:base"]
description = "Build base Docker image locally (Kali + system packages, amd64)"
run = '''
docker build -t apollos-ai-base:local \
  --platform linux/amd64 \
  --build-arg CACHE_DATE=$(date +%Y-%m-%d:%H:%M:%S) \
  docker/base
'''
sources = ["docker/base/**"]

[tasks."docker:build:app"]
description = "Build app Docker image from a git branch (default: main, amd64)"
run = '''
BRANCH="${1:-main}"
docker build -t apollos-ai-${BRANCH} \
  --platform linux/amd64 \
  --build-arg BRANCH=${BRANCH} \
  --build-arg CACHE_DATE=$(date +%Y-%m-%d:%H:%M:%S) \
  docker/run
'''
sources = ["docker/run/**"]

[tasks."docker:build:local"]
description = "Build local Docker image from working tree (amd64)"
run = '''
docker build -f DockerfileLocal -t apollos-ai-local \
  --platform linux/amd64 .
'''

[tasks."docker:build"]
description = "Build base + local Docker images in order"
depends = ["docker:build:base", "docker:build:local"]

# --- Push tasks ---

[tasks."docker:push:base"]
description = "Build and push base image to GHCR (amd64)"
run = '''
docker buildx build -t ghcr.io/jrmatherly/apollos-ai-base:latest \
  --platform linux/amd64 --push \
  --build-arg CACHE_DATE=$(date +%Y-%m-%d:%H:%M:%S) \
  docker/base
'''

[tasks."docker:push:app"]
description = "Build and push app image to GHCR (amd64, default branch: main)"
run = '''
BRANCH="${1:-main}"
docker buildx build \
  -t ghcr.io/jrmatherly/apollos-ai:${BRANCH} \
  --platform linux/amd64 --push \
  --build-arg BRANCH=${BRANCH} \
  --build-arg CACHE_DATE=$(date +%Y-%m-%d:%H:%M:%S) \
  docker/run
'''
[tasks."docker:push"]
description = "Build and push app image to GHCR (amd64, default branch: main)"
depends = ["docker:push:base", "docker:push:app"]

# --- Run tasks ---

[tasks."docker:run"]
description = "Run local Docker container (amd64)"
run = "docker run -it --platform linux/amd64 -p 50080:80 apollos-ai-local"

# --- Deploy Compose tasks ---

[tasks."docker:up"]
description = "Start deploy stack with GHCR images"
run = "docker compose -f deploy/docker/docker-compose.yml --profile proxy --profile postgres up -d"

[tasks."docker:up:local"]
description = "Start deploy stack with locally built image"
run = "docker compose -f deploy/docker/docker-compose.yml -f deploy/docker/docker-compose.local.yml --profile proxy --profile postgres up -d"

[tasks."docker:up:app"]
description = "Start app only (no proxy, no database)"
run = "docker compose -f deploy/docker/docker-compose.yml up -d"

[tasks."docker:up:app:local"]
description = "Start app only with local image (no proxy, no database)"
run = "docker compose -f deploy/docker/docker-compose.yml -f deploy/docker/docker-compose.local.yml up -d"

[tasks."docker:down"]
description = "Stop deploy stack"
run = "docker compose -f deploy/docker/docker-compose.yml --profile proxy --profile postgres down"

[tasks."docker:down:local"]
description = "Stop local deploy stack"
run = "docker compose -f deploy/docker/docker-compose.yml -f deploy/docker/docker-compose.local.yml --profile proxy --profile postgres down"

[tasks."docker:down:local:clean"]
description = "Stop local deploy stack and remove volumes"
run = "docker compose -f deploy/docker/docker-compose.yml -f deploy/docker/docker-compose.local.yml --profile proxy --profile postgres down -v"

[tasks."docker:logs"]
description = "Tail deploy stack logs"
run = "docker compose -f deploy/docker/docker-compose.yml logs -f"

[tasks."docker:logs:local"]
description = "Tail local deploy stack logs"
run = "docker compose -f deploy/docker/docker-compose.yml -f deploy/docker/docker-compose.local.yml logs -f"

# ============================================================================
# Git Hooks (hk)
# ============================================================================

[tasks."hooks:install"]
description = "Install git hooks via hk"
run = "hk install --mise"

[tasks."hooks:check"]
description = "Run all hook checks manually"
run = "hk check --all"

[tasks."hooks:fix"]
description = "Run all hook fixes"
run = "hk fix --all"

# ============================================================================
# Changelog & Release (git-cliff)
# ============================================================================

[tasks.changelog]
description = "Generate full changelog from git history"
run = "git-cliff --output CHANGELOG.md"

[tasks."changelog:latest"]
description = "Show changelog for latest version"
run = "git-cliff --latest"

[tasks."changelog:unreleased"]
description = "Show unreleased changes (preview next release)"
run = "git-cliff --unreleased"

[tasks."changelog:bump"]
description = "Bump version based on conventional commits"
run = "git-cliff --bump --output CHANGELOG.md"

[tasks.release]
description = "Create a release: bump version, changelog, commit, tag, push (usage: mise run release [version])"
usage = 'arg "[version]" help="Version to release (e.g. 0.2.1). Omit for auto-bump via conventional commits."'
raw = true
run = '''
#!/usr/bin/env bash
set -euo pipefail

# â”€â”€â”€ Determine version â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CURRENT=$(grep '^version' pyproject.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
echo "Current version: ${CURRENT}"

if [ -n "${usage_version:-}" ]; then
  NEW_VERSION="${usage_version}"
  # Strip leading 'v' if provided (e.g. v0.2.1 -> 0.2.1)
  NEW_VERSION="${NEW_VERSION#v}"
else
  # Auto-determine next version from conventional commits
  NEW_VERSION=$(git-cliff --bumped-version 2>/dev/null | sed 's/^v//')
  if [ -z "$NEW_VERSION" ] || [ "$NEW_VERSION" = "$CURRENT" ]; then
    echo "Error: No version bump detected from commits. Specify a version explicitly."
    exit 1
  fi
fi
TAG="v${NEW_VERSION}"

echo "New version: ${NEW_VERSION} (tag: ${TAG})"

# â”€â”€â”€ Guard: tag must not exist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if git rev-parse "${TAG}" >/dev/null 2>&1; then
  echo "Error: Tag ${TAG} already exists."
  exit 1
fi

# â”€â”€â”€ Guard: working tree must be clean â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ -n "$(git status --porcelain)" ]; then
  echo "Error: Working tree is not clean. Commit or stash changes first."
  exit 1
fi

# â”€â”€â”€ Confirm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo "This will:"
echo "  1. Update pyproject.toml version to ${NEW_VERSION}"
echo "  2. Sync uv.lock"
echo "  3. Generate CHANGELOG.md for ${TAG}"
echo "  4. Commit: \"chore(release): ${TAG}\""
echo "  5. Create git tag ${TAG}"
echo "  6. Push commit + tag to origin (triggers CI release + Docker build)"
echo ""
read -rp "Proceed? [y/N] " confirm
if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
  echo "Aborted."
  exit 0
fi

# â”€â”€â”€ 1. Bump version in pyproject.toml â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
sed -i.bak "s/^version = \"${CURRENT}\"/version = \"${NEW_VERSION}\"/" pyproject.toml
rm -f pyproject.toml.bak
echo "âœ“ pyproject.toml â†’ ${NEW_VERSION}"

# â”€â”€â”€ 2. Sync lockfile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
uv lock
echo "âœ“ uv.lock synced"

# â”€â”€â”€ 3. Generate changelog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
git-cliff --tag "${TAG}" --output CHANGELOG.md
echo "âœ“ CHANGELOG.md updated"

# â”€â”€â”€ 4. Commit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
git add pyproject.toml uv.lock CHANGELOG.md
git commit -m "chore(release): ${TAG}"
echo "âœ“ Committed"

# â”€â”€â”€ 5. Tag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
git tag -a "${TAG}" -m "Release ${TAG}"
echo "âœ“ Tagged ${TAG}"

# â”€â”€â”€ 6. Push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
git push origin main "${TAG}"
echo "âœ“ Pushed to origin"

echo ""
echo "Release ${TAG} is live. CI will create the GitHub Release and Docker image."
echo "  â†’ https://github.com/jrmatherly/apollos-ai/actions"
'''

# ============================================================================
# Drift â€” Codebase Pattern Analysis & Institutional Memory
# ============================================================================

# --- Scanning & Status ---

[tasks."drift:scan"]
description = "Full codebase pattern scan"
run = "drift scan --verbose"

[tasks."drift:scan:incremental"]
description = "Incremental scan (changed files only)"
run = "drift scan --incremental"

[tasks."drift:status"]
description = "Quick codebase health overview"
run = "drift status"

[tasks."drift:next"]
description = "Get personalized recommendations for next steps"
run = "drift next-steps"

# --- Infrastructure Build ---

[tasks."drift:build"]
description = "Build all drift infrastructure (callgraph, coupling, test-topology)"
run = '''
drift callgraph build
drift coupling build
drift test-topology
echo "Drift infrastructure built."
'''

[tasks."drift:callgraph"]
description = "Build call graph from source"
run = "drift callgraph build"

[tasks."drift:coupling"]
description = "Build module coupling analysis"
run = "drift coupling build"

# --- Python-Specific Analysis ---

[tasks."drift:py"]
description = "Python project analysis summary"
run = "drift py status"

[tasks."drift:py:routes"]
description = "List all Python HTTP routes (Flask, FastAPI)"
run = "drift py routes"

[tasks."drift:py:errors"]
description = "Analyze Python error handling patterns"
run = "drift py errors"

[tasks."drift:py:data"]
description = "Analyze Python database access patterns"
run = "drift py data-access"

[tasks."drift:py:decorators"]
description = "Analyze Python decorator usage"
run = "drift py decorators"

[tasks."drift:py:async"]
description = "Analyze Python async patterns"
run = "drift py async"

# --- Pattern Management ---

[tasks."drift:patterns"]
description = "List all discovered patterns"
run = "drift patterns list"

[tasks."drift:patterns:approved"]
description = "List approved patterns only"
run = "drift patterns list --approved"

# --- Analysis Commands ---

[tasks."drift:coupling:cycles"]
description = "Detect circular dependency cycles"
run = "drift coupling cycles"

[tasks."drift:coupling:hotspots"]
description = "Find highly coupled modules"
run = "drift coupling hotspots"

[tasks."drift:boundaries"]
description = "Show data access boundaries and violations"
run = "drift boundaries"

[tasks."drift:errors"]
description = "Analyze error handling patterns and gaps"
run = "drift error-handling"

[tasks."drift:env"]
description = "Show environment variable access patterns"
run = "drift env"

[tasks."drift:constants"]
description = "Analyze constants and hardcoded values"
run = "drift constants"

[tasks."drift:test-topology"]
description = "Analyze test-to-code mappings"
run = "drift test-topology"

# --- Cortex Memory ---

[tasks."drift:memory"]
description = "Show Cortex memory system status"
run = "drift memory status"

[tasks."drift:memory:health"]
description = "Get Cortex memory health report"
run = "drift memory health"

[tasks."drift:memory:search"]
description = "Search Cortex memories"
usage = 'arg "<query>" help="Search query"'
run = 'drift memory search "${usage_query}"'

[tasks."drift:memory:why"]
description = "Get context for a task area"
usage = 'arg "<topic>" help="Topic to get context for"'
run = 'drift memory why "${usage_topic}"'

[tasks."drift:memory:validate"]
description = "Validate and heal stale memories"
run = "drift memory validate --scope stale"

[tasks."drift:memory:consolidate"]
description = "Consolidate episodic memories into semantic knowledge"
run = "drift memory consolidate"

[tasks."drift:memory:backup"]
description = "Export Cortex memories to JSON backup"
run = 'drift memory export ".drift/memory/backup-$(date +%Y%m%d).json"'

# --- Quality Gates & CI ---

[tasks."drift:check"]
description = "Check for pattern violations (pre-commit friendly)"
run = "drift check"

[tasks."drift:check:staged"]
description = "Check only staged files for violations"
run = "drift check --staged"

[tasks."drift:gate"]
description = "Run quality gates"
run = "drift gate"

# --- Reports & Export ---

[tasks."drift:report"]
description = "Generate analysis report"
run = "drift report"

[tasks."drift:report:json"]
description = "Generate JSON analysis report"
run = "drift report --format json"

[tasks."drift:export"]
description = "Export manifest for AI consumption"
run = "drift export --format ai-context"

# --- Maintenance ---

[tasks."drift:audit"]
description = "Audit patterns for duplicates and cross-reference issues"
run = "drift audit"

[tasks."drift:troubleshoot"]
description = "Diagnose common drift issues"
run = "drift troubleshoot"

[tasks."drift:backup"]
description = "Create full .drift backup"
run = "drift backup create"

# ============================================================================
# CI Pipeline
# ============================================================================

[tasks.ci]
description = "Run all CI checks (lint, format, test)"
depends = ["format:check", "lint", "test"]

# ============================================================================
# Utilities
# ============================================================================

[tasks.clean]
description = "Remove build artifacts and caches"
run = '''
rm -rf .ruff_cache .pytest_cache __pycache__
find . -path ./.venv -prune -o -type d -name __pycache__ -print -exec rm -rf {} + 2>/dev/null || true
find . -path ./.venv -prune -o -type f -name '*.pyc' -print -delete 2>/dev/null || true
echo "Cleaned."
'''

[tasks."clean:all"]
description = "Full project reset â€” remove all runtime data, logs, caches, and user settings for a clean launch"
run = '''
echo "ðŸ§¹ Apollos AI â€” Full Clean"
echo ""

# --- 1. Python caches (same as 'mise clean') ---
echo "â†’ Python caches..."
rm -rf .ruff_cache .pytest_cache __pycache__ .coverage htmlcov
find . -path ./.venv -prune -o -type d -name __pycache__ -print -exec rm -rf {} + 2>/dev/null || true
find . -path ./.venv -prune -o -type f -name '*.pyc' -print -delete 2>/dev/null || true

# --- 2. User settings (persists across restarts â€” this is the big one) ---
echo "â†’ User settings & secrets..."
rm -f usr/settings.json
rm -f usr/secrets.env
rm -f usr/auth_token_cache.bin
rm -f usr/auth.db

# --- 3. Chat history ---
echo "â†’ Chat history..."
find usr/chats -mindepth 1 ! -name '.gitkeep' -exec rm -rf {} + 2>/dev/null || true

# --- 4. Agent memory (FAISS indexes, embeddings, knowledge imports) ---
echo "â†’ Agent memory..."
find usr/memory -mindepth 1 ! -name '.gitkeep' -exec rm -rf {} + 2>/dev/null || true

# --- 5. User knowledge uploads (preserve .gitkeep in subdirs) ---
echo "â†’ User knowledge..."
find usr/knowledge -mindepth 1 ! -name '.gitkeep' ! -type d -exec rm -rf {} + 2>/dev/null || true
find usr/knowledge -mindepth 2 -type d -empty -exec rmdir {} + 2>/dev/null || true

# --- 6. Scheduler tasks ---
echo "â†’ Scheduler..."
find usr/scheduler -mindepth 1 ! -name '.gitkeep' -exec rm -rf {} + 2>/dev/null || true

# --- 7. Agent profiles (user-customized) ---
echo "â†’ Agent profiles..."
find usr/agents -mindepth 1 ! -name '.gitkeep' -exec rm -rf {} + 2>/dev/null || true

# --- 8. User workdir ---
echo "â†’ User workdir..."
find usr/workdir -mindepth 1 ! -name '.gitkeep' -exec rm -rf {} + 2>/dev/null || true

# --- 9. User skills ---
echo "â†’ User skills..."
find usr/skills -mindepth 1 ! -name '.gitkeep' -exec rm -rf {} + 2>/dev/null || true

# --- 10. Logs ---
echo "â†’ Logs..."
find logs -mindepth 1 ! -name '.gitkeep' -exec rm -rf {} + 2>/dev/null || true

# --- 11. Tmp (embedding cache, runtime temp files) ---
echo "â†’ Tmp & embedding cache..."
find tmp -mindepth 1 ! -name '.gitkeep' -exec rm -rf {} + 2>/dev/null || true

# --- 12. Knowledge fragments (runtime-generated, not tracked) ---
echo "â†’ Knowledge fragments..."
find knowledge/fragments -mindepth 1 -exec rm -rf {} + 2>/dev/null || true

# --- 13. Browser artifacts ---
echo "â†’ Browser artifacts..."
rm -f agent_history.gif

echo ""
echo "âœ… Full clean complete. Run 'mise run r' for a fresh start."
'''

[tasks.info]
description = "Show project info and tool versions"
run = '''
echo "=== ${BRAND_NAME:-Apollos AI} - Environment Info ==="
echo ""
echo "Python: $(python --version)"
echo "uv: $(uv --version)"
echo "Ruff: $(ruff --version)"
echo "Biome: $(biome --version)"
echo "git-cliff: $(git-cliff --version)"
echo "hk: $(hk --version)"
echo "drift: $(drift --version)"
echo "mise: $(mise --version)"
echo ""
echo "Working directory: $(pwd)"
echo ""
echo "=== Ready to develop! ==="
'''
