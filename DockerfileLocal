# Use the pre-built base image for A0
# FROM apollos-ai-base:local
FROM ghcr.io/jrmatherly/apollos-ai-base:latest

# Set BRANCH to "local" if not provided
ARG BRANCH=local
ENV BRANCH=$BRANCH

# Copy filesystem files to root (installation scripts)
COPY ./docker/run/fs/ /

# --- Layer-cached dependency install ---
# Copy only dependency-related files first. This layer is cached as long
# as requirements.txt and overrides.txt don't change, avoiding a full
# re-download of Python packages on every source code edit.
COPY requirements.txt overrides.txt /git/apollos-ai/

# pre installation steps
RUN bash /ins/pre_install.sh $BRANCH

# Install Python packages (cached unless requirements change)
RUN . /ins/setup_venv.sh && \
    uv pip install -r /git/apollos-ai/requirements.txt \
    --overrides /git/apollos-ai/overrides.txt && \
    bash /ins/install_playwright.sh $BRANCH

# --- Source code (changes here don't re-download packages) ---
COPY ./ /git/apollos-ai

# Preload models
RUN . /ins/setup_venv.sh && \
    python /git/apollos-ai/preload.py --dockerized=true

# post installation steps
RUN bash /ins/post_install.sh $BRANCH

# Expose ports
EXPOSE 22 80 9000-9009

RUN chmod +x /exe/initialize.sh /exe/run_A0.sh /exe/run_searxng.sh /exe/run_tunnel_api.sh

# initialize runtime and switch to supervisord
CMD ["sh", "-c", "exec /exe/initialize.sh $BRANCH"]
